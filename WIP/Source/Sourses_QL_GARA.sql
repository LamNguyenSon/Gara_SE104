CREATE DATABASE QL_GARA
GO
USE QL_GARA
GO
CREATE TABLE TAIKHOAN
(
MATK CHAR(10) PRIMARY KEY,

TENDN CHAR(20),
MATKHAU CHAR(20),
NGAYTAO DATETIME ,
)
GO
CREATE TABLE NHANVIEN 
(
MANV CHAR(10) PRIMARY KEY,
MATK CHAR(10) REFERENCES TAIKHOAN(MATK),
HOTEN NVARCHAR(20),
GIOITINH CHAR(3),
NGAYSINH DATETIME,
SDT CHAR(12),
CMND CHAR(10),
DIACHI NVARCHAR(20)
)
GO
CREATE TABLE BAOCAOTHANG
(
MABCT CHAR(10) PRIMARY KEY,
DOANHTHU MONEY ,
NGAYLAP DATETIME
)
GO
CREATE TABLE KHACHHANG
(
MAKH CHAR(10)PRIMARY KEY,
HOTEN NVARCHAR(20),
GIOITINH CHAR(3),
NGAYSINH DATETIME,
SDT CHAR(12),
CMND CHAR(10),
DIACHI NVARCHAR(20),
BIENSO CHAR(10),
LOAIXE CHAR(10)
)
GO
CREATE TABLE PHIEUTHUTIEN 
(
MAPTT CHAR(10) PRIMARY KEY,
MABCT CHAR(10) REFERENCES BAOCAOTHANG(MABCT),
MAKH CHAR(10) REFERENCES KHACHHANG(MAKH),
NGAYTHU DATETIME,
TIENTHU MONEY
)
GO
CREATE TABLE PHIEUSUACHUA
(
MAPSC CHAR(10) PRIMARY KEY,
MANV CHAR(10) REFERENCES NHANVIEN(MANV),
MAKH CHAR(10) REFERENCES KHACHHANG(MAKH),
NGAYSUACHUA DATETIME,
THANHTIEN MONEY
)
GO
CREATE TABLE PHUTUNG 
(
MAPT CHAR(10)PRIMARY KEY,
MABCT CHAR(10) REFERENCES BAOCAOTHANG(MABCT),
TENPT NVARCHAR(20),
DONGGIA MONEY ,
SOLUONG INT
)
GO
CREATE TABLE THONGTINSUACHUA
(
MAPT CHAR(10) REFERENCES PHUTUNG(MAPT),
MAPSC CHAR(10)REFERENCES PHIEUSUACHUA(MAPSC),
LOAISUACHUA INT ,--1 SUA CHUA--2 THAY MỚI
MOTA NVARCHAR(20),
SLPT_SUDUNG INT,
CHIPHI MONEY,
PRIMARY KEY(MAPT,MAPSC)
)
--DROP DATABASE QL_GARA
INSERT INTO TAIKHOAN VALUES('TK01','NV1','123456','07/05/2017')
INSERT INTO TAIKHOAN VALUES('TK02','NV2','123456','01/05/2013')
INSERT INTO TAIKHOAN VALUES('TK03','NV3','123456','04/01/2012')
INSERT INTO TAIKHOAN VALUES('TK04','NV4','123456','07/05/1998')
INSERT INTO TAIKHOAN VALUES('TK05','NV5','123456','07/02/1788')
--SELECT *FROM TAIKHOAN
-----------------------------
INSERT INTO NHANVIEN VALUES ('NV01','TK01','NGUYEN VAN A','NAM','08/08/1998','0989587761','272785421',N'TPHCM')
INSERT INTO NHANVIEN VALUES ('NV02','TK02','NGUYEN VAN B','NAM','08/08/1997','0989588765','272787654',N'HN')
INSERT INTO NHANVIEN VALUES ('NV03','TK03','NGUYEN VAN C','NAM','08/08/1995','0989580987','272789087',N'VUNGT TAU')
INSERT INTO NHANVIEN VALUES ('NV04','TK04','NGUYEN VAN D','NAM','08/08/1993','0989583542','272790765',N'NHA TRANG')
INSERT INTO NHANVIEN VALUES ('NV05','TK05','NGUYEN VAN E','NAM','08/08/1992','0989580000','272756890',N'TPHCM')

--SELECT *FROM NHANVIEN
INSERT INTO BAOCAOTHANG VALUES('BCT01',0,'08/03/1998')
INSERT INTO BAOCAOTHANG VALUES('BCT02',0,'08/03/1996')
INSERT INTO BAOCAOTHANG VALUES('BCT03',0,'08/03/2000')
INSERT INTO BAOCAOTHANG VALUES('BCT04',0,'08/03/2017')
INSERT INTO BAOCAOTHANG VALUES('BCT05',0,'08/03/2015')
--
INSERT INTO KHACHHANG VALUES('KH01','PHAM VAN A','NU','11/12/1991','0989581234','272709890','DONG NAI','kind1','bs01')
INSERT INTO KHACHHANG VALUES('KH02','PHAM VAN R','NU','11/12/1992','0989586534','272708909','HA NOI','kind2','bs02')
INSERT INTO KHACHHANG VALUES('KH03','PHAM VAN E','NU','11/12/1995','0989580999','272701111','TPHCM','kind3','bs03')
INSERT INTO KHACHHANG VALUES('KH04','PHAM VAN J','NU','11/12/1997','0989580666','272702345','DONG NAI','kind4','bs04')
INSERT INTO KHACHHANG VALUES('KH05','PHAM VAN L','NU','11/12/1999','0989585555','272700762','DONG THAP','kind5','bs05')
--
INSERT INTO PHIEUTHUTIEN VALUES('PTT01','BCT01','KH01','04/06/1999',3000000)
INSERT INTO PHIEUTHUTIEN VALUES('PTT02','BCT02','KH02','04/06/2018',2000000)
INSERT INTO PHIEUTHUTIEN VALUES('PTT03','BCT03','KH03','04/06/2000',500000)
INSERT INTO PHIEUTHUTIEN VALUES('PTT04','BCT04','KH04','04/06/2015',200000)
INSERT INTO PHIEUTHUTIEN VALUES('PTT05','BCT05','KH05','04/06/2011',7000000)
--SELECT *FROM PHIEUTHUTIEN
--
INSERT INTO PHIEUSUACHUA VALUES('PSC01','NV01','KH01','08/02/2000',0)
INSERT INTO PHIEUSUACHUA VALUES('PSC02','NV02','KH02','08/02/2001',0)
INSERT INTO PHIEUSUACHUA VALUES('PSC03','NV03','KH03','08/02/2002',0)
INSERT INTO PHIEUSUACHUA VALUES('PSC04','NV04','KH04','08/02/2003',0)
INSERT INTO PHIEUSUACHUA VALUES('PSC05','NV05','KH05','08/02/2006',0)
---
INSERT INTO PHUTUNG VALUES ('PT01','BCT01','BUGI',2000000,4)
INSERT INTO PHUTUNG VALUES ('PT02','BCT02','BANH XE',1000000,3)
INSERT INTO PHUTUNG VALUES ('PT03','BCT03','THUNGNHOT',200000,1)
INSERT INTO PHUTUNG VALUES ('PT04','BCT04','GHE',5000000,8)
INSERT INTO PHUTUNG VALUES ('PT05','BCT05','LAUKINH',3000000,7)
---
INSERT INTO THONGTINSUACHUA VALUES ('PT01','PSC01',1,'SỬA LỌC NHỚT',0,2000000)
INSERT INTO THONGTINSUACHUA VALUES ('PT02','PSC02',2,'THAY BÁNH TRƯỚC',2,6000000)
INSERT INTO THONGTINSUACHUA VALUES ('PT03','PSC03',2,'THAY BUGI',1,3000000)
INSERT INTO THONGTINSUACHUA VALUES ('PT04','PSC04',1,'SỬA VOLAN',0,2000000)
INSERT INTO THONGTINSUACHUA VALUES ('PT05','PSC05',1,'SỬA ĐỒ LAU KÍNH',0,2000000)
GO

--------------------------------------------------------------------------------------------
--STRIGGER TỰ ĐỘNG TRỪ SỐ LƯỢNG PHỤ TÙNG KHI SỬ DỤNG
CREATE TRIGGER REDUCE_SL_PHUTUNG ON THONGTINSUACHUA
FOR INSERT,UPDATE
AS 
BEGIN
DECLARE @SLPT INT,@MAPT CHAR(12)

SELECT @SLPT=SOLUONG-Inserted.SLPT_SUDUNG,@MAPT=Inserted.MAPT FROM Inserted JOIN dbo.PHUTUNG ON PHUTUNG.MAPT = Inserted.MAPT
IF(@SLPT<0)
BEGIN

PRINT N'KHÔNG ĐỦ PHỤ TÙNG ĐỂ SỬ DỤNG'
ROLLBACK TRANSACTION
END
ELSE
BEGIN

UPDATE dbo.PHUTUNG
SET SOLUONG=@SLPT
WHERE MAPT=@MAPT

END
END
------------TRIGGER TỰ ĐỘNG TÍNH DOANH THU BÁO THÁNG
GO
CREATE TRIGGER TINHDOANHTHU ON PHIEUTHUTIEN
FOR INSERT,UPDATE
AS 
BEGIN
DECLARE @TONGDOANHTHU INT,@MABCT CHAR(12)
SELECT @TONGDOANHTHU=SUM (TIENTHU),@MABCT=BAOCAOTHANG.MABCT FROM Inserted JOIN dbo.BAOCAOTHANG ON BAOCAOTHANG.MABCT=Inserted.MABCT AND MONTH(Inserted.NGAYTHU)=MONTH(NGAYLAP) 
AND YEAR(Inserted.NGAYTHU)=YEAR(NGAYLAP)
GROUP BY BAOCAOTHANG.MABCT
UPDATE dbo.BAOCAOTHANG
SET DOANHTHU=@TONGDOANHTHU
WHERE MABCT=@MABCT
END